<!doctype html>  

<!-- paulirish.com/2008/conditional-stylesheets-vs-css-hacks-answer-neither/ --> 
<!--[if lt IE 7 ]> <html lang="en" class="no-js ie6"> <![endif]-->
<!--[if IE 7 ]>    <html lang="en" class="no-js ie7"> <![endif]-->
<!--[if IE 8 ]>    <html lang="en" class="no-js ie8"> <![endif]-->
<!--[if IE 9 ]>    <html lang="en" class="no-js ie9"> <![endif]-->
<!--[if (gt IE 9)|!(IE)]><!--> <html lang="en" class="no-js"> <!--<![endif]-->
<head>
	<meta charset="utf-8">

	<!-- Always force latest IE rendering engine (even in intranet) & Chrome Frame 
	Remove this if you use the .htaccess -->
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

	<title></title>
	<meta name="description" content="">
	<meta name="author" content="">

	<!--  Mobile viewport optimized: j.mp/bplateviewport -->
	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<!-- Place favicon.ico & apple-touch-icon.png in the root of your domain and delete these references -->
	<link rel="shortcut icon" href="/favicon.ico">
	<link rel="apple-touch-icon" href="/apple-touch-icon.png">


	<!-- CSS : implied media="all" -->
	<link rel="stylesheet" href="css/style.css?v=2">

	<!-- Uncomment if you are specifically targeting less enabled mobile browsers
	<link rel="stylesheet" media="handheld" href="css/handheld.css?v=2">  -->

	<!-- All JavaScript at the bottom, except for Modernizr which enables HTML5 elements & feature detects -->
	<script src="js/libs/modernizr-1.6.min.js"></script>

</head>

<body>

	<div id="container">
		<header>

		</header>
		
		<div id="main">
			<h2 id="instructions">Enter your Credentials</h2><br>
			<div id="step1">
				<form>
					<label for="aws_key">AWS Key</label><input type="text" name="key" id="aws_key" /><br />
					<label for="aws_secret">AWS Secret</label><input type="text" name="secret" id="aws_secret" /><br /><br />
					<input type="button" value="continue" onclick="from_step_1()" />
				</form>
			</div>
			
			<div id="step2" style="display:none">
				<ul id="buckets"></ul>
			</div>
			
			<div id="step3" style="display: none">
				<ul id="songs"></ul>
				<audio id="playa-play" controls="controls" preload="auto">
					No audio support... sorry
				</audio>
			</div>
		</div>

		<footer>

		</footer>
	</div> <!--! end of #container -->


	<!-- Javascript at the bottom for fast page loading -->

	<!-- Grab Google CDN's jQuery. fall back to local if necessary -->
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.js"></script>
	<script>!window.jQuery && document.write(unescape('%3Cscript src="js/libs/jquery-1.4.2.js"%3E%3C/script%3E'))</script>


	<!-- scripts concatenated and minified via ant build script-->
	<script src="js/plugins.js"></script>
	<script src="js/script.js"></script>
	<!-- end concatenated and minified scripts-->


	<!--[if lt IE 7 ]>
	<script src="js/libs/dd_belatedpng.js"></script>
	<script> DD_belatedPNG.fix('img, .png_bg'); //fix any <img> or .png_bg background-images </script>
	<![endif]-->

	<!-- S3 scripts -->
	<script src="js/libs/json2.js" type="text/javascript" charset="utf-8"></script>
	<script src="js/libs/sha1.js" type="text/javascript" charset="utf-8"></script>
	<script src="js/libs/S3Ajax.js" type="text/javascript" charset="utf-8"></script>
	<!-- end S3 scripts -->
	
	<!-- MY FAVORITE SCRIPT -->
	<script src="js/libs/underscore.min.js" type="text/javascript" charset="utf-8"></script>
	<!-- end MY FAVORITE SCRIPT -->
	
	
	<!-- ID3tag scripts -->
    <script src="js/libs/stringutils.js" type="text/javascript" charset="utf-8"></script>
    <script src="js/libs/bufferedbinaryajax.js" type="text/javascript" charset="utf-8"></script>
    <script src="js/libs/base64.js" type="text/javascript" charset="utf-8"></script>
    <script src="js/libs/id3.js" type="text/javascript" charset="utf-8"></script>
    <script src="js/libs/id3v1.js" type="text/javascript" charset="utf-8"></script>
    <script src="js/libs/id3v2.js" type="text/javascript" charset="utf-8"></script>
    <script src="js/libs/id3v2frames.js" type="text/javascript" charset="utf-8"></script>
    <script src="js/libs/id4.js" type="text/javascript" charset="utf-8"></script>
	<!-- end ID3tag scripts -->
	
	
	<!-- app scripts -->
	<script src="js/mylibs/song.js" type="text/javascript" charset="utf-8"></script>
	<script src="js/mylibs/manifest.js" type="text/javascript" charset="utf-8"></script>
	<script src="js/mylibs/utils.js" type="text/javascript" charset="utf-8"></script>
	<script src="js/mylibs/playlist.js" type="text/javascript" charset="utf-8"></script>
	<!-- end app scripts -->
	
	<script type="text/javascript" charset="utf-8">				
		var manifest = null;
		var playlist = Playlist([]);
		var main_bucket = '';						
		
		var from_step_1 = function() {
			// get info
			if (S3Ajax.KEY_ID.length == 0)
				S3Ajax.KEY_ID = $('#aws_key').val();
			if (S3Ajax.SECRET_KEY.length == 0)
				S3Ajax.SECRET_KEY = $('#aws_secret').val();
			
			// move to next step
			S3Ajax.listBuckets(function(request, obj) {
				var buckets = obj.ListAllMyBucketsResult.Buckets.Bucket;
				for (i=0; i < buckets.length; i++) {
					var bucket = buckets[i];
					$('#buckets').append('<li><a href="#" onclick="from_step_2(\'' + bucket.Name + '\')">' + bucket.Name + '</a></li>');
				}
				
				$('#step1').slideUp();
				$('#instructions').html('Choose a bucket');
				$('#step2').slideDown();
			}, function(request, object) {
				alert('Your keys are wrong, try again.');
			})
		}
		
		var from_step_2 = function(bucket_name) {	
			main_bucket = bucket_name;
			manifest = Manifest(bucket_name);
			
			manifest.sync({
				update: true,
				callback: function() {
					generate_list(bucket_name, manifest.db);
				}
			});
			
			$('#step2').slideUp();
			$('#instructions').html('Choose a song');
			$('#step3').slideDown();
		}
		
		var change_playlist = function() {
			var audio = document.getElementById('playa-play');
			
			
			audio.pause();
			
		}
		
		var change_song = function(src) {
			var audio = document.getElementById('playa-play');
			
			audio.pause();
			audio.setAttribute('src', src);
		}
		
		var queue_album_playlist = function(artist, album) {
			var songs = manifest.artist_album_songs(artist, album);
			
			playlist = Playlist(_(songs).map(function(song) {return song.key}));
			change_song(Utils.url(main_bucket, playlist.current()));
		}
		
		var queue_artist_playlist = function(artist) {
			var songs = _(manifest.artist_albums(artist)).chain()
				.map((function(artist, manifest){ return function(album) {
					return manifest.artist_album_songs(artist, album);
				}})(artist, manifest))
				.flatten()
				.value();
			
			playlist = Playlist(_(songs).map(function(song) {return song.key}));
			change_song(Utils.url(main_bucket, playlist.current()));
		}
		
		var	generate_list = function(bucket, db) {
			$('#songs').empty();
			var list = $('#songs');

			for (var artist in db) {
				var artist_li = $('<li>');
				var artist_a = $('<a>', {href: "#"}).html(artist);
				var artist_ul = $('<ul>');
				artist_li.append(artist_a);
				list.append(artist_li);
				list.append(artist_ul);
				
				artist_a.click((function(artist) {
					return function() {
						queue_artist_playlist(artist);
					}
				})(artist));
				
				for (var album in db[artist]) {
					var album_li = $('<li>');
					var album_a = $('<a>', {href: "#"}).html(album);
					var album_ul = $('<ul>');
					album_li.append(album_a);
					artist_ul.append(album_li);
					artist_ul.append(album_ul);
					
					album_a.click((function(artist, album) {
						return function() {
							queue_album_playlist(artist, album);
						}
					})(artist, album));
					
					// order the tracks
					var tracks = [];
					for(var track_no in db[artist][album]) {
						tracks.push(track_no);
					}
					tracks.sort(function(i, j){ return i - j;})
					
					for (i=0; i<tracks.length; i++) {
						var track_no = tracks[i];
						var song = db[artist][album][track_no];
						var li = $('<li>')
						var a = $('<a>', {href: '#'}).html(track_no + '. ' + song.title);
						a.click((function(bucket, key) {
							return function() {
								change_song(Utils.url(bucket, key));
							}
						})(bucket, song.key));
						li.append(a);
						album_ul.append(li);
					}
				}
			}
		}
		
		// Events
		var audio = document.getElementById('playa-play');
		
		audio.addEventListener('ended', function() {
			var new_song = playlist.next();
			if (new_song) {
				change_song(Utils.url(main_bucket, new_song));
			}
		});
		
		audio.addEventListener('canplay', function() {
			audio.play();
		});
	</script>
</body>
</html>